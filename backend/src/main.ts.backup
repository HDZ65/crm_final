import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { AiStandaloneModule } from './infrastructure/framework/nest/ai-standalone.module';

/**
 * Point d'entrÃ©e pour le serveur AI autonome (sans PostgreSQL)
 * Pour dÃ©marrer: npm run start:ai
 */

// Force UTF-8 encoding for Node.js on Windows
if (process.platform === 'win32') {
  process.env.NODE_OPTIONS = '--input-type=module';
  // Set default encoding
  if (process.stdout.setEncoding) {
    process.stdout.setEncoding('utf8');
  }
  if (process.stderr.setEncoding) {
    process.stderr.setEncoding('utf8');
  }
}

async function bootstrap() {
  const app = await NestFactory.create(AiStandaloneModule);

  // Global validation pipe
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  // Enable CORS if needed
  app.enableCors();

  const port = process.env.PORT || 3000;
  await app.listen(port);

  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ¤– AI Module Started (Standalone Mode)     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Server running on: http://localhost:${port}  â•‘
â•‘   LLM gRPC: ${process.env.LLM_GRPC_ADDR || 'localhost:50051'}           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Endpoints:                                  â•‘
â•‘   GET /ai/generate-once?q=<prompt>           â•‘
â•‘   GET /ai/generate?q=<prompt> (SSE)          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
}

bootstrap();
