graph TB
    subgraph "PHASE 1: SOUSCRIPTION & MANDAT"
        A["ğŸ“‹ CLIENT SOUSCRIT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Collecte des infos paiement:<br/>â€¢ IBAN pour SEPA<br/>â€¢ Carte bancaire pour CB<br/>â€¢ CoordonnÃ©es client"] --> B["ğŸ”€ PSP ROUTER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SÃ©lection intelligente du PSP:<br/>â€¢ Selon table PSP_ROUTE<br/>â€¢ CritÃ¨res: mÃ©thode paiement,<br/>  prioritÃ©, disponibilitÃ©<br/>â€¢ Ex: GoCardless pour SEPA"]
        B --> C["ğŸ‘¤ CRÃ‰ER CUSTOMER PSP<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Appel API PSP sÃ©lectionnÃ©:<br/>â€¢ POST /customers<br/>â€¢ Retour: psp_customer_id<br/>â€¢ Stockage dans CUSTOMER"]
        C --> D["ğŸ“ CRÃ‰ER MANDATE/TOKEN<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>GÃ©nÃ©ration mandat SEPA:<br/>â€¢ POST /mandates<br/>â€¢ Retour: psp_mandate_id<br/>â€¢ PDF mandat gÃ©nÃ©rÃ© par PSP"]
        D --> E["âœï¸ SIGNATURE YOUSIGN<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Signature Ã©lectronique optionnelle:<br/>â€¢ Si requis lÃ©galement<br/>â€¢ Envoi lien signature client<br/>â€¢ Horodatage de la signature"]
        E --> F["ğŸ’¾ ARCHIVER PDF GED<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Stockage documentaire:<br/>â€¢ Upload PDF dans GED<br/>â€¢ Retour: ged_document_id<br/>â€¢ TraÃ§abilitÃ© lÃ©gale 7 ans"]
        F --> G["ğŸ“… GÃ‰NÃ‰RER SCHEDULE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>CrÃ©ation Ã©chÃ©ancier paiement:<br/>â€¢ Montants TTC par Ã©chÃ©ance<br/>â€¢ Dates de prÃ©lÃ¨vement<br/>â€¢ Statut initial: planned<br/>â€¢ FrÃ©quence: mensuel/annuel"]
        G --> H{"â³ VALIDATION DOUBLE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>1ï¸âƒ£ J+14 rÃ©tractation dÃ©passÃ©e?<br/>2ï¸âƒ£ ContrÃ´le QualitÃ© validÃ©?"}
        H -->|"âŒ Non<br/>En attente"| WAIT["â¸ï¸ ATTENTE VALIDATION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Blocage du prÃ©lÃ¨vement:<br/>â€¢ PÃ©riode rÃ©tractation en cours<br/>â€¢ OU CQ non validÃ©<br/>â€¢ VÃ©rification quotidienne"]
        H -->|"âœ… Oui<br/>Go prÃ©lÃ¨vement"| I
    end

    subgraph "PSP INTÃ‰GRÃ‰S - Orchestrateur Multi-Prestataires"
        PSP1["ğŸ¦ GoCardless<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PRIORITÃ‰ pour SEPA<br/>â€¢ Mandats SEPA Direct Debit<br/>â€¢ PrÃ©lÃ¨vements automatiques<br/>â€¢ Faibles frais"]
        PSP2["ğŸ”„ Slimpay<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SEPA RÃ©current<br/>â€¢ Abonnements rÃ©currents<br/>â€¢ Gestion mandats avancÃ©e<br/>â€¢ Compliance DSP2"]
        PSP3["ğŸ’³ Multisafepay<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SEPA/CB Hybride<br/>â€¢ Paiements ponctuels<br/>â€¢ Paiements rÃ©currents<br/>â€¢ Multi-mÃ©thodes"]
        PSP4["ğŸŒ Emerchantpay<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SEPA/CB International<br/>â€¢ Gateway global<br/>â€¢ Tokenisation CB<br/>â€¢ Anti-fraude avancÃ©"]
        PSP5["âš¡ Stripe<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>OPTIONNEL<br/>â€¢ Backup PSP<br/>â€¢ Paiements modernes<br/>â€¢ API developer-friendly"]
    end

    subgraph "PHASE 2: PRÃ‰LÃˆVEMENT & WEBHOOKS"
        I["ğŸ” CRÃ‰ER PAYMENT_INTENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PrÃ©paration prÃ©lÃ¨vement:<br/>â€¢ GÃ©nÃ©ration idempotency_key unique<br/>  Format: contract_id_schedule_id_timestamp<br/>â€¢ Montant + devise + mandat<br/>â€¢ Protection double-crÃ©ation<br/>â€¢ Statut initial: created"]
        I --> J["ğŸš€ DÃ‰CLENCHER PRÃ‰LÃˆVEMENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Appel API PSP:<br/>â€¢ POST /payments<br/>â€¢ RÃ©fÃ©rence idempotency_key<br/>â€¢ Retour: psp_payment_id<br/>â€¢ Statut: pending"]
        J --> K["âš™ï¸ PSP TRAITE PAIEMENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Traitement par le PSP:<br/>â€¢ Validation IBAN/CB<br/>â€¢ VÃ©rification fonds<br/>â€¢ Communication bancaire<br/>â€¢ Statut: processing<br/>â€¢ DÃ©lai: 1-5 jours SEPA"]
        K --> L{"ğŸ“¡ WEBHOOK PSP REÃ‡U<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Normalisation Ã©vÃ©nement:<br/>â€¢ VÃ©rification signature webhook<br/>â€¢ Mapping format PSP â†’ interne<br/>â€¢ Extraction event_type<br/>â€¢ Payload JSON brut conservÃ©"}

        L -->|"âœ… payment_confirmed<br/>SuccÃ¨s"| M["ğŸ‰ PAIEMENT CONFIRMÃ‰<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions automatiques:<br/>1ï¸âƒ£ INSERT PAYMENT_EVENT<br/>2ï¸âƒ£ UPDATE SCHEDULE.status=paid<br/>3ï¸âƒ£ UPDATE INVOICE.status=paid<br/>4ï¸âƒ£ INSERT LEDGER_ENTRY<br/>   â€¢ DÃ©bit: 512000 Banque<br/>   â€¢ CrÃ©dit: 411000 Client<br/>5ï¸âƒ£ Email confirmation client"]

        L -->|"âŒ payment_failed<br/>Ã‰chec"| N["âš ï¸ PAIEMENT Ã‰CHOUÃ‰<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions automatiques:<br/>1ï¸âƒ£ INSERT PAYMENT_EVENT<br/>2ï¸âƒ£ UPDATE SCHEDULE.status=failed<br/>3ï¸âƒ£ IncrÃ©menter retry_count<br/>4ï¸âƒ£ Log raison Ã©chec:<br/>   â€¢ Fonds insuffisants<br/>   â€¢ IBAN invalide<br/>   â€¢ Compte clÃ´turÃ©<br/>5ï¸âƒ£ DÃ©clenchement DUNNING"]

        L -->|"ğŸš« mandate_cancelled<br/>Annulation"| O["ğŸ”´ MANDAT ANNULÃ‰<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions automatiques:<br/>1ï¸âƒ£ INSERT PAYMENT_EVENT<br/>2ï¸âƒ£ UPDATE MANDATE.status=cancelled<br/>3ï¸âƒ£ Annuler SCHEDULE futurs<br/>4ï¸âƒ£ Notifier back-office<br/>5ï¸âƒ£ Email client confirmation<br/>6ï¸âƒ£ Bloquer nouveaux prÃ©lÃ¨vements"]
    end

    subgraph "PHASE 3: DUNNING & RECOUVREMENT"
        N --> P{"ğŸ“Š ANALYSE HISTORIQUE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Compteur rejets consÃ©cutifs?<br/>â€¢ RequÃªte: retry_count sur SCHEDULE<br/>â€¢ VÃ©rification historique client<br/>â€¢ Scoring risque impayÃ©"}

        P -->|"1ï¸âƒ£ Premier rejet<br/>TolÃ©rance"| Q["ğŸ’° FRAIS DE REJET J0<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Frais paramÃ©trables (table config):<br/>â€¢ FT Mobile: 10â‚¬ TTC<br/>â€¢ Bleubox: 15â‚¬ TTC<br/>â€¢ Autre: selon paramÃ©trage<br/><br/>ğŸ“§ RELANCE NIVEAU 1 - J0:<br/>â€¢ Email: 'Ã‰chec prÃ©lÃ¨vement'<br/>â€¢ SMS: 'RÃ©gularisez paiement'<br/>â€¢ Ton: informatif, courtois<br/><br/>ğŸ”„ RETRY AUTOMATIQUE:<br/>â€¢ ProgrammÃ© Ã  J+3<br/>â€¢ Nouveau PAYMENT_INTENT<br/>â€¢ MÃªme mandat rÃ©utilisÃ©"]

        P -->|"2ï¸âƒ£ DeuxiÃ¨me rejet<br/>Alerte"| R["âš ï¸ ESCALADE NIVEAU 2 - J0<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ’° Frais cumulÃ©s:<br/>â€¢ Frais rejet 1 + Frais rejet 2<br/>â€¢ PÃ©nalitÃ©s de retard possibles<br/><br/>ğŸ“§ RELANCE NIVEAU 2 - J0:<br/>â€¢ Email: 'Suspension imminente'<br/>â€¢ SMS: 'Urgence paiement'<br/>â€¢ Ton: ferme, ultimatum<br/><br/>ğŸš¨ SUSPENSION AUTOMATIQUE:<br/>â€¢ DÃ©clenchement immÃ©diat<br/>â€¢ Appel API prestataires tÃ©lÃ©com<br/>â€¢ Coupure services J0+1<br/><br/>ğŸ”„ DERNIER RETRY:<br/>â€¢ ProgrammÃ© Ã  J+7<br/>â€¢ DerniÃ¨re chance avant contentieux"]

        P -->|"3ï¸âƒ£ TroisiÃ¨me+ rejet<br/>ImpayÃ©"| S["ğŸ”´ IMPAYÃ‰ DÃ‰FINITIF<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ“‹ Statut final:<br/>â€¢ SCHEDULE.status = unpaid<br/>â€¢ INVOICE.status = dunning<br/>â€¢ Flag client: mauvais payeur<br/><br/>âš–ï¸ ESCALADE CONTENTIEUX:<br/>â€¢ Export liste recouvrement<br/>â€¢ Notification service juridique<br/>â€¢ Mise en demeure postale<br/>â€¢ PossibilitÃ© huissier si >500â‚¬<br/><br/>ğŸš« ArrÃªt retry automatique:<br/>â€¢ Traitement manuel uniquement<br/>â€¢ Accord paiement Ã©chelonnÃ©"]

        R --> T["ğŸ“± API MTV<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Suspension SIM mobile:<br/>â€¢ POST /suspend<br/>â€¢ Service: voix+data<br/>â€¢ ImmÃ©diat"]
        R --> U["ğŸ“¶ API ReducBox<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Suspension box internet:<br/>â€¢ POST /suspend<br/>â€¢ Service: accÃ¨s internet<br/>â€¢ DÃ©lai: 24h"]
        R --> V["ğŸŒ API Transatel/Networth<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Suspension services opÃ©rateur:<br/>â€¢ POST /accounts/suspend<br/>â€¢ Multi-services<br/>â€¢ Log action"]
        T & U & V --> W["ğŸ”’ SERVICES SUSPENDUS<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mise Ã  jour base:<br/>â€¢ SERVICE_LINK.status = suspended<br/>â€¢ suspended_at = TIMESTAMP<br/>â€¢ suspension_reason = payment_failure<br/><br/>ğŸ“§ Notification client:<br/>â€¢ Email suspension confirmÃ©e<br/>â€¢ ProcÃ©dure rÃ©activation<br/>â€¢ Montant dÃ» pour dÃ©blocage"]

        Q --> X["ğŸ” RETRY AUTOMATIQUE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Nouvelle tentative programmÃ©e:<br/>â€¢ CrÃ©ation nouveau PAYMENT_INTENT<br/>â€¢ Nouveau idempotency_key<br/>â€¢ RÃ©utilisation mÃªme mandat<br/>â€¢ Notification Ã©quipe recouvrement"]
        X --> J
    end

    subgraph "BASE DE DONNÃ‰ES - Tables Critiques"
        DB0[("ğŸ“‹ PSP_ROUTE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>RÃ©fÃ©rentiel prestataires<br/>â€¢ id: UUID<br/>â€¢ psp_name: enum<br/>â€¢ priority: int<br/>â€¢ payment_method: SEPA/CB<br/>â€¢ is_active: boolean<br/>â€¢ config: JSON credentials")]
        DB1[("ğŸ‘¤ CUSTOMER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Clients PSP<br/>â€¢ id: UUID<br/>â€¢ psp_name: enum<br/>â€¢ psp_customer_id: string<br/>â€¢ email: string<br/>â€¢ metadata: JSON<br/>â€¢ created_at: timestamp")]
        DB2[("ğŸ“ MANDATE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mandats SEPA/Tokens CB<br/>â€¢ id: UUID<br/>â€¢ customer_id: FK<br/>â€¢ psp_mandate_id: string<br/>â€¢ ged_document_id: string<br/>â€¢ status: enum<br/>â€¢ signed_at: timestamp")]
        DB3[("ğŸ“… SCHEDULE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Ã‰chÃ©ancier paiements<br/>â€¢ id: UUID<br/>â€¢ contract_id: FK<br/>â€¢ amount_ttc: decimal<br/>â€¢ due_date: date<br/>â€¢ status: enum<br/>â€¢ retry_count: int")]
        DB4[("ğŸ’³ PAYMENT_INTENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Tentatives paiement<br/>â€¢ id: UUID<br/>â€¢ schedule_id: FK<br/>â€¢ mandate_id: FK<br/>â€¢ idempotency_key: string UNIQUE<br/>â€¢ psp_payment_id: string<br/>â€¢ status: enum<br/>â€¢ amount: decimal")]
        DB5[("ğŸ“¡ PAYMENT_EVENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Ã‰vÃ©nements webhooks<br/>â€¢ id: UUID<br/>â€¢ payment_intent_id: FK<br/>â€¢ event_type: enum<br/>â€¢ raw_payload: JSON<br/>â€¢ received_at: timestamp<br/>â€¢ processed: boolean")]
        DB6[("ğŸ§¾ INVOICE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Factures<br/>â€¢ id: UUID<br/>â€¢ contract_id: FK<br/>â€¢ amount_ht: decimal<br/>â€¢ amount_ttc: decimal<br/>â€¢ rejection_fees: decimal<br/>â€¢ status: enum<br/>â€¢ invoice_date: date")]
        DB7[("ğŸ“Š LEDGER_ENTRY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Ã‰critures comptables<br/>â€¢ id: UUID<br/>â€¢ payment_event_id: FK<br/>â€¢ account_type: string<br/>â€¢ account_code: string<br/>â€¢ debit: decimal<br/>â€¢ credit: decimal<br/>â€¢ entry_date: timestamp")]
        DB8[("ğŸ”— SERVICE_LINK<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Liens services tÃ©lÃ©com<br/>â€¢ id: UUID<br/>â€¢ contract_id: FK<br/>â€¢ provider: enum MTV/ReducBox/Transatel<br/>â€¢ external_service_id: string<br/>â€¢ status: active/suspended/terminated<br/>â€¢ suspended_at: timestamp")]
    end

    subgraph "PHASE 4: EXPORTS COMPTABLES"
        M --> EXP1["ğŸ’š EXPORT RÃˆGLEMENTS<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Paiements confirmÃ©s:<br/>â€¢ Format: CSV/Excel/XML<br/>â€¢ Colonnes: Date, Client,<br/>  Montant, Facture, PSP<br/>â€¢ FrÃ©quence: quotidien<br/>â€¢ Compte: 512000 (Banque)"]
        N --> EXP2["ğŸ’” EXPORT IMPAYÃ‰S/DUNNING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Paiements Ã©chouÃ©s:<br/>â€¢ Format: CSV/Excel<br/>â€¢ Colonnes: Client, Montant dÃ»,<br/>  Nb rejets, Statut, Actions<br/>â€¢ FrÃ©quence: quotidien<br/>â€¢ Pour recouvrement<br/>â€¢ Compte: 416000 (CrÃ©ances douteuses)"]
        EXP1 & EXP2 --> EXP3["ğŸ“¦ LIVRABLE COMPTABILITÃ‰<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Formats standardisÃ©s:<br/>â€¢ FEC (Fichier Ã‰critures Comptables)<br/>  Norme fiscale franÃ§aise<br/>â€¢ Export Sage Compta<br/>â€¢ Export Cegid<br/>â€¢ Export EBP<br/><br/>Contenu:<br/>â€¢ Journal des ventes<br/>â€¢ Journal banque<br/>â€¢ Balance auxiliaire clients<br/>â€¢ Ã‰tats de rapprochement bancaire"]
    end

    subgraph "STATUTS - Cycle de Vie Paiement"
        ST1["ğŸ“‹ planned<br/>Ã‰chÃ©ance planifiÃ©e<br/>Pas encore dÃ©clenchÃ©e"] --> ST2["â³ pending<br/>PrÃ©lÃ¨vement dÃ©clenchÃ©<br/>EnvoyÃ© au PSP"]
        ST2 --> ST3["âš™ï¸ processing<br/>En cours traitement<br/>Banque sollicitÃ©e"]
        ST3 --> ST4["âœ… confirmed<br/>Paiement confirmÃ©<br/>Fonds reÃ§us"]
        ST3 --> ST5["âŒ failed<br/>Paiement Ã©chouÃ©<br/>Raison enregistrÃ©e"]
        ST5 --> ST6["ğŸ”„ retry_1<br/>1Ã¨re tentative retry<br/>J+3"]
        ST6 --> ST3
        ST6 --> ST7["ğŸ”„ retry_2<br/>2Ã¨me tentative retry<br/>J+7"]
        ST7 --> ST3
        ST7 --> ST8["ğŸ’” unpaid<br/>ImpayÃ© dÃ©finitif<br/>CrÃ©ance douteuse"]
        ST8 --> ST9["âš–ï¸ dunning<br/>En recouvrement<br/>Contentieux"]
    end

    B -.SÃ©lection.-> DB0
    B -.Route vers.-> PSP1 & PSP2 & PSP3 & PSP4 & PSP5
    C --> DB1
    D --> DB2
    G --> DB3
    I --> DB4
    L --> DB5
    M --> DB6
    M --> DB7
    W --> DB8

    PSP1 & PSP2 & PSP3 & PSP4 & PSP5 -.Webhooks.-> L

    style A fill:#e3f2fd
    style H fill:#fff9c4
    style M fill:#c8e6c9
    style N fill:#ffcdd2
    style R fill:#ff9800,color:#fff
    style S fill:#f44336,color:#fff
    style W fill:#ff5722,color:#fff
    style EXP3 fill:#9c27b0,color:#fff
    style ST4 fill:#4caf50,color:#fff
    style ST5 fill:#f44336,color:#fff
    style ST9 fill:#9c27b0,color:#fff
    style DB0 fill:#ffd54f