graph TB
    subgraph "LAYER 1: ORCHESTRATION & ROUTING"
        START["ğŸ¯ DÃ‰CLENCHEUR<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Sources:<br/>â€¢ Souscription client<br/>â€¢ Job scheduler (cron J+14)<br/>â€¢ Retry automatique<br/>â€¢ Action manuelle back-office"] --> ROUTER["ğŸ§  PAYMENT ORCHESTRATOR<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Intelligence centrale:<br/>â€¢ Charge PSP_ROUTE config<br/>â€¢ SÃ©lection PSP selon:<br/>  - Payment method (SEPA/CB)<br/>  - Priority ranking<br/>  - Health check status<br/>  - Geographic zone<br/>â€¢ Circuit breaker: 5 fails = switch PSP"]

        ROUTER --> CHECK_CONTEXT{"ğŸ” CONTEXTE VALIDE?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>VÃ©rifications:<br/>âœ“ Contract.status = active<br/>âœ“ J+14 rÃ©tractation dÃ©passÃ©e<br/>âœ“ CQ validÃ©<br/>âœ“ Mandate actif<br/>âœ“ Pas de blocage fraude<br/>âœ“ Client solvable"}

        CHECK_CONTEXT -->|"âŒ KO"| BLOCK["ğŸš« BLOCAGE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions:<br/>â€¢ Log raison blocage<br/>â€¢ Notification back-office<br/>â€¢ Schedule status = blocked<br/>â€¢ Alerte si bloquÃ© >7j"]

        CHECK_CONTEXT -->|"âœ… OK"| SELECT_PSP["ğŸ² SÃ‰LECTION PSP<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Algorithme:<br/>1. Filtrer PSP actifs pour method<br/>2. Trier par priority ASC<br/>3. Health check (ping API)<br/>4. Fallback si unavailable<br/>5. Log PSP sÃ©lectionnÃ©"]
    end

    subgraph "LAYER 2: PSP ABSTRACTION LAYER"
        SELECT_PSP --> ADAPTER{"ğŸ”Œ PSP ADAPTER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Normalisation interface:<br/>â€¢ Adapter pattern<br/>â€¢ Abstraction API calls<br/>â€¢ Retry logic (3 attempts)<br/>â€¢ Timeout: 30s<br/>â€¢ Error mapping"}

        ADAPTER -->|"Route SEPA<br/>Priority 1"| PSP_GC["ğŸ¦ GoCardless Adapter<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SpÃ©cialitÃ©: SEPA DD<br/>Methods:<br/>â€¢ createCustomer()<br/>â€¢ createMandate()<br/>â€¢ createPayment()<br/>â€¢ getPaymentStatus()<br/>Rate limit: 100 req/min"]

        ADAPTER -->|"Route SEPA<br/>Priority 2"| PSP_SP["ğŸ”„ Slimpay Adapter<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SpÃ©cialitÃ©: SEPA RÃ©current<br/>Methods:<br/>â€¢ setupRecurring()<br/>â€¢ signMandate()<br/>â€¢ collectPayment()<br/>Rate limit: 50 req/min"]

        ADAPTER -->|"Route CB<br/>Priority 1"| PSP_MS["ğŸ’³ Multisafepay Adapter<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SpÃ©cialitÃ©: CB/SEPA Hybrid<br/>Methods:<br/>â€¢ tokenizeCard()<br/>â€¢ chargeToken()<br/>â€¢ refund()<br/>3DS2 compliant"]

        ADAPTER -->|"Route CB<br/>Priority 2"| PSP_EM["ğŸŒ Emerchantpay Adapter<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SpÃ©cialitÃ©: International<br/>Methods:<br/>â€¢ processPayment()<br/>â€¢ fraudCheck()<br/>Rate limit: 200 req/min"]

        ADAPTER -->|"Fallback<br/>All methods"| PSP_ST["âš¡ Stripe Adapter<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Backup universel<br/>Methods:<br/>â€¢ createCustomer()<br/>â€¢ createSetupIntent()<br/>â€¢ createPaymentIntent()<br/>Reliability: 99.99%"]
    end

    subgraph "LAYER 3: WORKFLOW TRANSACTIONNEL"
        PSP_GC & PSP_SP & PSP_MS & PSP_EM & PSP_ST --> TXN_START["âš¡ TRANSACTION START<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BEGIN TRANSACTION<br/>â€¢ Isolation: SERIALIZABLE<br/>â€¢ Lock: SCHEDULE row<br/>â€¢ GÃ©nÃ©rer idempotency_key<br/>  SHA256(contract+schedule+nonce)<br/>â€¢ Set status = processing"]

        TXN_START --> CREATE_INTENT["ğŸ“ CREATE PAYMENT_INTENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>INSERT avec UPSERT:<br/>â€¢ ON CONFLICT idempotency_key<br/>  DO NOTHING RETURNING id<br/>â€¢ Montant + devise<br/>â€¢ Mandat reference<br/>â€¢ Metadata enrichie"]

        CREATE_INTENT --> API_CALL["ğŸŒ APPEL API PSP<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>HTTP Request:<br/>â€¢ POST /payments<br/>â€¢ Headers: idempotency key,<br/>  API key, signature<br/>â€¢ Body: normalized payload<br/>â€¢ Timeout: 30s<br/>â€¢ Retry: exponential backoff"]

        API_CALL --> API_RESPONSE{"ğŸ“¨ RÃ‰PONSE API?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"}

        API_RESPONSE -->|"âœ… 200/201<br/>Success"| COMMIT_TXN["âœ… COMMIT TRANSACTION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions atomiques:<br/>â€¢ UPDATE SCHEDULE<br/>  status = pending<br/>â€¢ UPDATE PAYMENT_INTENT<br/>  psp_payment_id = XXX<br/>â€¢ INSERT PAYMENT_EVENT<br/>  type = payment_initiated<br/>â€¢ COMMIT"]

        API_RESPONSE -->|"âŒ 4xx/5xx<br/>Error"| HANDLE_ERROR["âš ï¸ ERROR HANDLER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Classification:<br/>â€¢ 400: Invalid request â†’ BLOCK<br/>â€¢ 401: Auth failed â†’ Alert ops<br/>â€¢ 429: Rate limit â†’ Retry +60s<br/>â€¢ 500: Server error â†’ Fallback PSP<br/>â€¢ Timeout: Retry exponential<br/>Log dans ERROR_LOG table"]

        HANDLE_ERROR --> FALLBACK_DECISION{"ğŸ”€ FALLBACK?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>CritÃ¨res:<br/>â€¢ Error retryable?<br/>â€¢ Fallback PSP exists?<br/>â€¢ Circuit not open?<br/>â€¢ Max fallback < 3?"}

        FALLBACK_DECISION -->|"âœ… Oui"| SELECT_PSP
        FALLBACK_DECISION -->|"âŒ Non"| ROLLBACK_TXN["âŒ ROLLBACK<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Annulation complÃ¨te:<br/>â€¢ ROLLBACK TRANSACTION<br/>â€¢ SCHEDULE status = failed<br/>â€¢ Notification alerte<br/>â€¢ Programmer retry +1h"]

        API_RESPONSE -->|"â³ Timeout<br/>No response"| ASYNC_CHECK["â±ï¸ ASYNC VERIFICATION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Job asynchrone:<br/>â€¢ Attendre 5 min<br/>â€¢ GET /payments/id status<br/>â€¢ Si toujours timeout:<br/>  polling toutes les 30min<br/>â€¢ Max polling: 24h<br/>â€¢ Alerte ops aprÃ¨s 2h"]
    end

    subgraph "LAYER 4: EVENT-DRIVEN WEBHOOKS"
        WEBHOOK_IN["ğŸ“¡ WEBHOOK ENDPOINT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>/webhooks/:psp_name<br/>â€¢ IP whitelist validation<br/>â€¢ Signature verification<br/>â€¢ Rate limiting: 1000/min<br/>â€¢ Return 200 immediately<br/>â€¢ Queue for async processing"]

        WEBHOOK_IN --> WEBHOOK_QUEUE["ğŸ“¬ MESSAGE QUEUE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BullMQ / RabbitMQ:<br/>â€¢ Queue: payment-events<br/>â€¢ Priority: high<br/>â€¢ Max retry: 5<br/>â€¢ DLQ: dead-letter-queue<br/>â€¢ Concurrency: 10 workers"]

        WEBHOOK_QUEUE --> IDEMPOTENCY_CHECK{"ğŸ” IDEMPOTENCE CHECK<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Redis cache:<br/>â€¢ Key: psp_event_id<br/>â€¢ TTL: 7 days<br/>â€¢ Atomic SETNX<br/>DÃ©jÃ  traitÃ©?"}

        IDEMPOTENCY_CHECK -->|"âœ… Nouveau"| NORMALIZE["ğŸ”„ NORMALISATION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mapping Ã©vÃ©nement:<br/>â€¢ GoCardless: payment.confirmed<br/>  â†’ payment_confirmed<br/>â€¢ Slimpay: payment.executed<br/>  â†’ payment_confirmed<br/>â€¢ Extraction montant rÃ©el<br/>â€¢ Date effective paiement<br/>â€¢ Raison Ã©chec si failed"]

        IDEMPOTENCY_CHECK -->|"âŒ DÃ©jÃ  traitÃ©"| IGNORE["âœ‹ IGNORE EVENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions:<br/>â€¢ Log duplication<br/>â€¢ Increment metric<br/>â€¢ ACK message queue<br/>â€¢ Return success"]

        NORMALIZE --> EVENT_TYPE{"ğŸ­ TYPE Ã‰VÃ‰NEMENT?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"}

        EVENT_TYPE -->|"payment_confirmed"| CONFIRMED_FLOW["ğŸ‰ FLUX CONFIRMÃ‰<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BEGIN TRANSACTION<br/>1. INSERT PAYMENT_EVENT<br/>2. UPDATE SCHEDULE<br/>   status=paid, paid_at=NOW<br/>3. UPDATE INVOICE<br/>   status=paid, paid_at=NOW<br/>4. INSERT LEDGER_ENTRY<br/>   DÃ©bit 512000: +amount<br/>   CrÃ©dit 411000: -amount<br/>5. Mark retry_count = 0<br/>6. Cancel scheduled retries<br/>7. Email confirmation<br/>COMMIT"]

        EVENT_TYPE -->|"payment_failed"| FAILED_FLOW["âš ï¸ FLUX Ã‰CHEC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BEGIN TRANSACTION<br/>1. INSERT PAYMENT_EVENT<br/>   + failure_reason<br/>2. UPDATE SCHEDULE<br/>   status=failed<br/>   retry_count++<br/>   last_failure_at=NOW<br/>3. Classify error:<br/>   â€¢ insufficient_funds<br/>   â€¢ invalid_iban<br/>   â€¢ account_closed<br/>   â€¢ mandate_revoked<br/>4. COMMIT<br/>5. Trigger DUNNING"]

        EVENT_TYPE -->|"mandate_cancelled"| CANCELLED_FLOW["ğŸš« FLUX ANNULATION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BEGIN TRANSACTION<br/>1. INSERT PAYMENT_EVENT<br/>2. UPDATE MANDATE<br/>   status=cancelled<br/>   cancelled_at=NOW<br/>3. UPDATE all future SCHEDULE<br/>   status=cancelled<br/>4. Cancel all pending retries<br/>5. COMMIT<br/>6. Notification back-office<br/>7. Email client confirmation"]

        EVENT_TYPE -->|"payment_pending"| PENDING_FLOW["â³ FLUX ATTENTE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions limitÃ©es:<br/>â€¢ INSERT PAYMENT_EVENT<br/>â€¢ UPDATE status = processing<br/>â€¢ Pas de changement INVOICE<br/>â€¢ Set timeout alert: +5 jours<br/>â€¢ Normal pour SEPA (1-5j)"]
    end

    subgraph "LAYER 5: DUNNING ENGINE"
        FAILED_FLOW --> DUNNING_ENGINE["âš™ï¸ DUNNING ENGINE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Analyse contextuelle:<br/>â€¢ Load historique client<br/>â€¢ Calcul scoring risque<br/>â€¢ Load config frais par produit<br/>â€¢ VÃ©rification seuils suspension"]

        DUNNING_ENGINE --> CALCULATE_FEES["ğŸ’° CALCUL FRAIS<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Table REJECTION_FEES_CONFIG:<br/>SELECT fee WHERE<br/>  company_id = X<br/>  AND product_id = Y<br/><br/>Apply fees:<br/>â€¢ Create INVOICE_LINE<br/>  type=rejection_fee<br/>  amount=10â‚¬ or 15â‚¬<br/>â€¢ Link to next invoice"]

        CALCULATE_FEES --> RETRY_STRATEGY{"ğŸ¯ STRATÃ‰GIE RETRY?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Decision tree:<br/>retry_count value?"}

        RETRY_STRATEGY -->|"0 â†’ 1<br/>First fail"| RETRY_1["ğŸ“§ LEVEL 1 DUNNING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>J0 Actions:<br/>â€¢ Send email template 1<br/>  Subject: Ã‰chec prÃ©lÃ¨vement<br/>  Tone: informatif<br/>â€¢ Send SMS template 1<br/>  Urgent: rÃ©gularisez<br/>â€¢ Create DUNNING_ACTION log<br/>â€¢ Schedule retry: NOW + 3 days<br/>  via Job Queue<br/>â€¢ Metric: dunning_level_1++"]

        RETRY_STRATEGY -->|"1 â†’ 2<br/>Second fail"| RETRY_2["ğŸš¨ LEVEL 2 DUNNING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>J0 Actions:<br/>â€¢ Send email template 2<br/>  Subject: URGENT suspension<br/>  Tone: ferme<br/>â€¢ Send SMS template 2<br/>  DerniÃ¨re chance<br/>â€¢ Create DUNNING_ACTION log<br/>â€¢ Schedule retry: NOW + 7 days<br/>â€¢ TRIGGER SUSPENSION workflow<br/>â€¢ Metric: dunning_level_2++"]

        RETRY_STRATEGY -->|"2 â†’ 3+<br/>Third+ fail"| RETRY_3["ğŸ”´ UNPAID STATUS<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Statut dÃ©finitif:<br/>â€¢ UPDATE SCHEDULE<br/>  status = unpaid<br/>â€¢ UPDATE INVOICE<br/>  status = dunning<br/>â€¢ Flag CLIENT<br/>  payment_risk = high<br/>â€¢ Stop all auto retries<br/>â€¢ Export to collection team<br/>â€¢ Possible legal action<br/>â€¢ Metric: unpaid_count++"]

        RETRY_2 --> SUSPEND_SERVICES["ğŸ”Œ SUSPENSION ENGINE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Workflow parallÃ¨le:<br/>â€¢ Load SERVICE_LINK<br/>  WHERE contract_id<br/>â€¢ For each provider:<br/>  - Call API suspend<br/>  - Log response<br/>  - Update status<br/>â€¢ Aggregate results<br/>â€¢ Email notification"]

        SUSPEND_SERVICES --> API_MTV["ğŸ“± MTV API<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>POST /sims/:id/suspend<br/>Circuit breaker: ON<br/>Retry: 3x<br/>Fallback: manual task"]

        SUSPEND_SERVICES --> API_REDUC["ğŸ“¶ ReducBox API<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>POST /boxes/:id/suspend<br/>Circuit breaker: ON<br/>Retry: 3x<br/>Fallback: manual task"]

        SUSPEND_SERVICES --> API_TRANS["ğŸŒ Transatel API<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>POST /accounts/:id/suspend<br/>Circuit breaker: ON<br/>Retry: 3x<br/>Fallback: manual task"]

        API_MTV & API_REDUC & API_TRANS --> UPDATE_SERVICE_LINK["ğŸ”— UPDATE SERVICE_LINK<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BEGIN TRANSACTION<br/>UPDATE SERVICE_LINK SET<br/>  status = suspended,<br/>  suspended_at = NOW(),<br/>  suspension_reason = payment_failure,<br/>  suspension_metadata = JSON<br/>COMMIT"]

        RETRY_1 --> SCHEDULE_RETRY["â° SCHEDULE RETRY JOB<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>BullMQ delayed job:<br/>â€¢ Name: retry-payment<br/>â€¢ Delay: 3 days (retry 1)<br/>        or 7 days (retry 2)<br/>â€¢ Payload: schedule_id<br/>â€¢ Priority: high<br/>â€¢ Job triggers START"]
    end

    subgraph "LAYER 6: JOB SCHEDULER"
        CRON["â° CRON SCHEDULER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Jobs quotidiens:<br/>1. Check J+14 contracts<br/>   â†’ Trigger payment<br/>2. Process scheduled retries<br/>3. Check pending > 5 days<br/>   â†’ Alert ops<br/>4. Health check PSPs<br/>5. Generate daily reports"]

        CRON --> QUERY_SCHEDULES["ğŸ” QUERY SCHEDULES<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>SQL:<br/>SELECT * FROM schedule<br/>WHERE status = planned<br/>  AND due_date <= TODAY<br/>  AND contract.status = active<br/>  AND contract.created_at <= TODAY - 14<br/>  AND contract.cq_validated = true"]

        QUERY_SCHEDULES --> BATCH_PROCESS["ğŸ“¦ BATCH PROCESSING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Pour chaque schedule:<br/>â€¢ Queue job payment<br/>â€¢ Rate limit: 100/sec<br/>â€¢ Spread over 1 hour<br/>â€¢ Monitor errors<br/>â€¢ Log processed IDs"]

        BATCH_PROCESS --> START
        SCHEDULE_RETRY --> START
    end

    subgraph "LAYER 7: RECONCILIATION"
        BANK_IMPORT["ğŸ¦ IMPORT BANCAIRE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Sources:<br/>â€¢ API bancaire (PSD2)<br/>â€¢ Import CFONB/SEPA XML<br/>â€¢ Upload CSV manuel<br/>Parse transactions:<br/>â€¢ Date valeur<br/>â€¢ Montant<br/>â€¢ LibellÃ©<br/>â€¢ Reference PSP"]

        BANK_IMPORT --> MATCHING["ğŸ” MATCHING ENGINE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Algorithme:<br/>1. Match exact sur reference<br/>2. Match montant + date Â±3j<br/>3. Fuzzy match libellÃ©<br/>4. Machine learning scoring<br/>Confidence: 0-100%"]

        MATCHING --> RECONCILED{"âœ… MATCHED?<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Confidence > 95%?"}

        RECONCILED -->|"âœ… Oui"| AUTO_RECONCILE["âœ… AUTO RECONCILIATION<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>UPDATE PAYMENT_INTENT<br/>  bank_reconciled = true<br/>  bank_transaction_id = X<br/>  reconciled_at = NOW<br/>Metric: reconciliation_rate++"]

        RECONCILED -->|"âŒ Non"| MANUAL_REVIEW["ğŸ‘¤ REVIEW MANUELLE<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Queue pour back-office:<br/>â€¢ Dashboard suspect trans<br/>â€¢ Propose matches<br/>â€¢ Allow manual linking<br/>â€¢ Detect fraude potentielle"]

        CONFIRMED_FLOW --> BANK_IMPORT
    end

    subgraph "LAYER 8: OBSERVABILITY"
        METRICS["ğŸ“Š METRICS & MONITORING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Prometheus metrics:<br/>â€¢ payment_success_rate<br/>â€¢ payment_latency_p95<br/>â€¢ psp_availability<br/>â€¢ dunning_efficiency<br/>â€¢ reconciliation_rate<br/>Dashboards Grafana"]

        ALERTS["ğŸš¨ ALERTING<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PagerDuty / Slack:<br/>â€¢ PSP down > 5min<br/>â€¢ Success rate < 90%<br/>â€¢ Pending > 1000<br/>â€¢ Unreconciled > 100<br/>â€¢ Webhook lag > 1h"]

        AUDIT_LOG["ğŸ“œ AUDIT LOG<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Immutable log:<br/>â€¢ Toutes mutations DB<br/>â€¢ API calls PSP<br/>â€¢ Webhook events<br/>â€¢ Manual actions<br/>Retention: 7 ans"]
    end

    COMMIT_TXN --> METRICS
    CONFIRMED_FLOW --> METRICS
    FAILED_FLOW --> METRICS
    HANDLE_ERROR --> ALERTS
    ASYNC_CHECK --> ALERTS
    CONFIRMED_FLOW --> AUDIT_LOG
    FAILED_FLOW --> AUDIT_LOG

    style START fill:#e3f2fd
    style ROUTER fill:#fff9c4
    style COMMIT_TXN fill:#c8e6c9
    style CONFIRMED_FLOW fill:#4caf50,color:#fff
    style FAILED_FLOW fill:#f44336,color:#fff
    style RETRY_2 fill:#ff9800,color:#fff
    style RETRY_3 fill:#9c27b0,color:#fff
    style SUSPEND_SERVICES fill:#ff5722,color:#fff
    style METRICS fill:#2196f3,color:#fff
    style ALERTS fill:#f44336,color:#fff