syntax = "proto3";

package payment;

// ==================== PAYMENT SERVICE ====================
// Service gRPC unifié pour tous les paiements (Stripe, PayPal, GoCardless, etc.)

service PaymentService {
  // ==================== STRIPE ====================
  // Checkout & Payment Intents
  rpc CreateStripeCheckoutSession(CreateStripeCheckoutSessionRequest) returns (StripeCheckoutSessionResponse);
  rpc CreateStripePaymentIntent(CreateStripePaymentIntentRequest) returns (StripePaymentIntentResponse);
  rpc GetStripePaymentIntent(GetByIdRequest) returns (StripePaymentIntentResponse);
  rpc CancelStripePaymentIntent(GetByIdRequest) returns (StripePaymentIntentResponse);

  // Customers
  rpc CreateStripeCustomer(CreateStripeCustomerRequest) returns (StripeCustomerResponse);
  rpc GetStripeCustomer(GetByIdRequest) returns (StripeCustomerResponse);

  // Subscriptions
  rpc CreateStripeSubscription(CreateStripeSubscriptionRequest) returns (StripeSubscriptionResponse);
  rpc GetStripeSubscription(GetByIdRequest) returns (StripeSubscriptionResponse);
  rpc CancelStripeSubscription(GetByIdRequest) returns (StripeSubscriptionResponse);

  // Refunds
  rpc CreateStripeRefund(CreateStripeRefundRequest) returns (StripeRefundResponse);

  // Setup Intents (for saving payment methods)
  rpc CreateStripeSetupIntent(CreateStripeSetupIntentRequest) returns (StripeSetupIntentResponse);

  // Billing Portal
  rpc CreateStripeBillingPortalSession(CreateStripeBillingPortalRequest) returns (StripeBillingPortalResponse);

  // ==================== PAYPAL ====================
  rpc CreatePayPalOrder(CreatePayPalOrderRequest) returns (PayPalOrderResponse);
  rpc GetPayPalOrder(GetPayPalOrderRequest) returns (PayPalOrderResponse);
  rpc CapturePayPalOrder(CapturePayPalOrderRequest) returns (PayPalCaptureResponse);
  rpc AuthorizePayPalOrder(GetPayPalOrderRequest) returns (PayPalOrderResponse);

  // ==================== GOCARDLESS ====================
  rpc SetupGoCardlessMandate(SetupGoCardlessMandateRequest) returns (GoCardlessMandateResponse);
  rpc GetGoCardlessMandate(GetGoCardlessMandateRequest) returns (GoCardlessMandateResponse);
  rpc CancelGoCardlessMandate(GetGoCardlessMandateRequest) returns (GoCardlessMandateResponse);
  rpc CreateGoCardlessPayment(CreateGoCardlessPaymentRequest) returns (GoCardlessPaymentResponse);
  rpc CreateGoCardlessSubscription(CreateGoCardlessSubscriptionRequest) returns (GoCardlessSubscriptionResponse);
  rpc CancelGoCardlessSubscription(CancelGoCardlessSubscriptionRequest) returns (GoCardlessSubscriptionResponse);

  // ==================== SCHEDULES ====================
  rpc CreateSchedule(CreateScheduleRequest) returns (ScheduleResponse);
  rpc GetSchedule(GetByIdRequest) returns (ScheduleResponse);
  rpc UpdateSchedule(UpdateScheduleRequest) returns (ScheduleResponse);
  rpc DeleteSchedule(GetByIdRequest) returns (DeleteResponse);
  rpc GetDueSchedules(GetDueSchedulesRequest) returns (ScheduleListResponse);
  rpc ProcessDuePayments(ProcessDuePaymentsRequest) returns (ProcessDuePaymentsResponse);
  rpc RenewSchedule(RenewScheduleRequest) returns (ScheduleResponse);

  // ==================== PAYMENT INTENTS (Internal) ====================
  rpc CreatePaymentIntent(CreatePaymentIntentRequest) returns (PaymentIntentResponse);
  rpc GetPaymentIntent(GetByIdRequest) returns (PaymentIntentResponse);
  rpc UpdatePaymentIntent(UpdatePaymentIntentRequest) returns (PaymentIntentResponse);
  rpc DeletePaymentIntent(GetByIdRequest) returns (DeleteResponse);

  // ==================== PAYMENT EVENTS ====================
  rpc CreatePaymentEvent(CreatePaymentEventRequest) returns (PaymentEventResponse);
  rpc GetPaymentEvent(GetByIdRequest) returns (PaymentEventResponse);
  rpc GetUnprocessedEvents(GetUnprocessedEventsRequest) returns (PaymentEventListResponse);
  rpc MarkEventProcessed(MarkEventProcessedRequest) returns (PaymentEventResponse);

  // ==================== PSP ACCOUNTS ====================
  rpc GetPSPAccountsSummary(GetPSPAccountsRequest) returns (PSPAccountsSummaryResponse);

  // ==================== SLIMPAY ====================
  rpc CreateSlimpayMandate(CreateSlimpayMandateRequest) returns (SlimpayMandateResponse);
  rpc GetSlimpayMandate(GetSlimpayMandateRequest) returns (SlimpayMandateResponse);
  rpc CancelSlimpayMandate(CancelSlimpayMandateRequest) returns (SlimpayMandateResponse);
  rpc CreateSlimpayPayment(CreateSlimpayPaymentRequest) returns (SlimpayPaymentResponse);
  rpc GetSlimpayPayment(GetSlimpayPaymentRequest) returns (SlimpayPaymentResponse);

  // ==================== MULTISAFEPAY ====================
  rpc CreateMultiSafepayTransaction(CreateMultiSafepayTransactionRequest) returns (MultiSafepayTransactionResponse);
  rpc GetMultiSafepayTransaction(GetMultiSafepayTransactionRequest) returns (MultiSafepayTransactionResponse);
  rpc RefundMultiSafepayTransaction(RefundMultiSafepayTransactionRequest) returns (MultiSafepayTransactionResponse);

  // ==================== EMERCHANTPAY ====================
  rpc CreateEmerchantpayPayment(CreateEmerchantpayPaymentRequest) returns (EmerchantpayPaymentResponse);
  rpc GetEmerchantpayPayment(GetEmerchantpayPaymentRequest) returns (EmerchantpayPaymentResponse);
  rpc CreateEmerchantpaySepaPayment(CreateEmerchantpaySepaPaymentRequest) returns (EmerchantpayPaymentResponse);
  rpc RefundEmerchantpayPayment(RefundEmerchantpayPaymentRequest) returns (EmerchantpayPaymentResponse);

  // ==================== PROVIDER ROUTING ====================
  rpc CreateRoutingRule(CreateRoutingRuleRequest) returns (RoutingRuleResponse);
  rpc UpdateRoutingRule(UpdateRoutingRuleRequest) returns (RoutingRuleResponse);
  rpc DeleteRoutingRule(DeleteRoutingRuleRequest) returns (DeleteRoutingRuleResponse);
  rpc ListRoutingRules(ListRoutingRulesRequest) returns (ListRoutingRulesResponse);
  rpc TestRoutingRule(TestRoutingRuleRequest) returns (TestRoutingRuleResponse);
  rpc CreateProviderOverride(CreateProviderOverrideRequest) returns (ProviderOverrideResponse);
  rpc DeleteProviderOverride(DeleteProviderOverrideRequest) returns (DeleteProviderOverrideResponse);
  rpc ListProviderOverrides(ListProviderOverridesRequest) returns (ListProviderOverridesResponse);
  rpc CreateReassignmentJob(CreateReassignmentJobRequest) returns (ReassignmentJobResponse);
  rpc GetReassignmentJob(GetReassignmentJobRequest) returns (ReassignmentJobResponse);

  // ==================== ALERTS ====================
  rpc ListAlerts(ListAlertsRequest) returns (ListAlertsResponse);
  rpc AcknowledgeAlert(AcknowledgeAlertRequest) returns (AlertResponse);
  rpc GetAlertStats(GetAlertStatsRequest) returns (AlertStatsResponse);

  // ==================== ACCOUNTING EXPORTS ====================
  rpc CreateExportJob(CreateExportJobRequest) returns (ExportJobResponse);
  rpc GetExportJob(GetExportJobRequest) returns (ExportJobResponse);
  rpc ListExportJobs(ListExportJobsRequest) returns (ListExportJobsResponse);
  rpc DownloadExport(DownloadExportRequest) returns (DownloadExportResponse);

  // ==================== RISK SCORING ====================
  rpc GetRiskScore(GetRiskScoreRequest) returns (RiskScoreResponse);
  rpc EvaluateRiskScore(EvaluateRiskScoreRequest) returns (RiskScoreResponse);
  rpc ListRiskScores(ListRiskScoresRequest) returns (ListRiskScoresResponse);
  rpc GetScoringStats(GetScoringStatsRequest) returns (ScoringStatsResponse);

  // ==================== BANK RECONCILIATION ====================
  rpc ImportBankStatement(ImportBankStatementRequest) returns (ImportBankStatementResponse);
  rpc GetReconciliationStatus(GetReconciliationStatusRequest) returns (ReconciliationStatusResponse);
  rpc ForceReconciliation(ForceReconciliationRequest) returns (ReconciliationResponse);
  rpc ListUnmatchedPayments(ListUnmatchedPaymentsRequest) returns (ListUnmatchedPaymentsResponse);

  // ==================== PROVIDER STATUS MAPPING ====================
  rpc ListProviderStatusMappings(ListProviderStatusMappingsRequest) returns (ListProviderStatusMappingsResponse);
  rpc UpdateProviderStatusMapping(UpdateProviderStatusMappingRequest) returns (ProviderStatusMappingResponse);

  // ==================== REJECTION REASONS ====================
  rpc ListRejectionReasons(ListRejectionReasonsRequest) returns (ListRejectionReasonsResponse);
  rpc CreateRejectionReason(CreateRejectionReasonRequest) returns (RejectionReasonResponse);
  rpc UpdateRejectionReason(UpdateRejectionReasonRequest) returns (RejectionReasonResponse);
}

// ==================== ENUMS ====================

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING = 1;
  PAYMENT_STATUS_SUBMITTED = 2;
  PAYMENT_STATUS_PAID = 3;
  PAYMENT_STATUS_REJECTED = 4;
  PAYMENT_STATUS_REFUNDED = 5;
  PAYMENT_STATUS_CANCELLED = 6;
  PAYMENT_STATUS_FAILED = 7;
}

enum MandateStatus {
  MANDATE_STATUS_UNSPECIFIED = 0;
  MANDATE_STATUS_PENDING_CUSTOMER_APPROVAL = 1;
  MANDATE_STATUS_PENDING_SUBMISSION = 2;
  MANDATE_STATUS_SUBMITTED = 3;
  MANDATE_STATUS_ACTIVE = 4;
  MANDATE_STATUS_SUSPENDED_BY_PAYER = 5;
  MANDATE_STATUS_FAILED = 6;
  MANDATE_STATUS_CANCELLED = 7;
  MANDATE_STATUS_EXPIRED = 8;
  MANDATE_STATUS_CONSUMED = 9;
  MANDATE_STATUS_BLOCKED = 10;
}

enum ScheduleStatus {
  SCHEDULE_STATUS_UNSPECIFIED = 0;
  SCHEDULE_STATUS_ACTIVE = 1;
  SCHEDULE_STATUS_PAUSED = 2;
  SCHEDULE_STATUS_CANCELLED = 3;
  SCHEDULE_STATUS_COMPLETED = 4;
}

enum AuditAction {
  AUDIT_ACTION_UNSPECIFIED = 0;
  AUDIT_ACTION_PAYMENT_CREATED = 1;
  AUDIT_ACTION_PAYMENT_SUBMITTED = 2;
  AUDIT_ACTION_PAYMENT_SUCCEEDED = 3;
  AUDIT_ACTION_PAYMENT_FAILED = 4;
  AUDIT_ACTION_PAYMENT_CANCELLED = 5;
  AUDIT_ACTION_PAYMENT_REFUNDED = 6;
  AUDIT_ACTION_MANDATE_CREATED = 7;
  AUDIT_ACTION_MANDATE_ACTIVATED = 8;
  AUDIT_ACTION_MANDATE_CANCELLED = 9;
  AUDIT_ACTION_SCHEDULE_CREATED = 10;
  AUDIT_ACTION_SCHEDULE_PAUSED = 11;
  AUDIT_ACTION_SCHEDULE_RESUMED = 12;
  AUDIT_ACTION_SCHEDULE_CANCELLED = 13;
}

// ==================== COMMON MESSAGES ====================

message Empty {}

message GetByIdRequest {
  string id = 1;
  string societe_id = 2;  // Pour le multi-tenant
}

message DeleteResponse {
  bool success = 1;
  string message = 2;
}

// ==================== STRIPE MESSAGES ====================

message CreateStripeCheckoutSessionRequest {
  string societe_id = 1;
  int64 amount = 2;  // En centimes
  string currency = 3;
  string mode = 4;  // 'payment', 'subscription', 'setup'
  string success_url = 5;
  string cancel_url = 6;
  optional string customer_id = 7;
  optional string customer_email = 8;
  optional string price_id = 9;  // Pour les abonnements
  map<string, string> metadata = 10;
  repeated LineItem line_items = 11;
}

message LineItem {
  string name = 1;
  string description = 2;
  int64 amount = 3;
  int32 quantity = 4;
  string currency = 5;
}

message StripeCheckoutSessionResponse {
  string id = 1;
  string url = 2;
  string status = 3;
  string payment_status = 4;
  optional string customer_id = 5;
  optional string subscription_id = 6;
}

message CreateStripePaymentIntentRequest {
  string societe_id = 1;
  int64 amount = 2;
  string currency = 3;
  optional string customer_id = 4;
  optional string description = 5;
  optional string payment_method = 6;
  bool confirm = 7;
  bool automatic_payment_methods = 8;
  map<string, string> metadata = 9;
}

message StripePaymentIntentResponse {
  string id = 1;
  int64 amount = 2;
  string currency = 3;
  string status = 4;
  optional string client_secret = 5;
  optional string customer_id = 6;
  optional string payment_method = 7;
}

message CreateStripeCustomerRequest {
  string societe_id = 1;
  string email = 2;
  optional string name = 3;
  optional string phone = 4;
  optional string description = 5;
  map<string, string> metadata = 6;
}

message StripeCustomerResponse {
  string id = 1;
  string email = 2;
  optional string name = 3;
  optional string phone = 4;
  int64 created = 5;
}

message CreateStripeSubscriptionRequest {
  string societe_id = 1;
  string customer_id = 2;
  string price_id = 3;
  optional string payment_method = 4;
  optional string default_payment_method = 5;
  map<string, string> metadata = 6;
}

message StripeSubscriptionResponse {
  string id = 1;
  string customer_id = 2;
  string status = 3;
  int64 current_period_start = 4;
  int64 current_period_end = 5;
  bool cancel_at_period_end = 6;
}

message CreateStripeRefundRequest {
  string societe_id = 1;
  string payment_intent_id = 2;
  optional int64 amount = 3;  // Partial refund, omit for full
  optional string reason = 4;
}

message StripeRefundResponse {
  string id = 1;
  int64 amount = 2;
  string currency = 3;
  string status = 4;
  string payment_intent_id = 5;
}

message CreateStripeSetupIntentRequest {
  string societe_id = 1;
  optional string customer_id = 2;
  repeated string payment_method_types = 3;
  map<string, string> metadata = 4;
}

message StripeSetupIntentResponse {
  string id = 1;
  string client_secret = 2;
  string status = 3;
  optional string customer_id = 4;
  optional string payment_method = 5;
}

message CreateStripeBillingPortalRequest {
  string societe_id = 1;
  string customer_id = 2;
  string return_url = 3;
}

message StripeBillingPortalResponse {
  string id = 1;
  string url = 2;
}

// ==================== PAYPAL MESSAGES ====================

message CreatePayPalOrderRequest {
  string societe_id = 1;
  string intent = 2;  // 'CAPTURE' or 'AUTHORIZE'
  repeated PayPalPurchaseUnit purchase_units = 3;
  string return_url = 4;
  string cancel_url = 5;
  map<string, string> metadata = 6;
}

message PayPalPurchaseUnit {
  optional string reference_id = 1;
  int64 amount = 2;  // En centimes
  string currency = 3;
  optional string description = 4;
  optional string custom_id = 5;
  optional string invoice_id = 6;
}

message PayPalOrderResponse {
  string id = 1;
  string status = 2;
  optional string approve_url = 3;
  optional string capture_url = 4;
  repeated PayPalLink links = 5;
}

message PayPalLink {
  string href = 1;
  string rel = 2;
  string method = 3;
}

message GetPayPalOrderRequest {
  string order_id = 1;
  string societe_id = 2;
}

message CapturePayPalOrderRequest {
  string order_id = 1;
  string societe_id = 2;
}

message PayPalCaptureResponse {
  string id = 1;
  string status = 2;
  optional PayPalPayer payer = 3;
  repeated PayPalCapturedPurchaseUnit purchase_units = 4;
}

message PayPalPayer {
  optional string email_address = 1;
  optional string payer_id = 2;
  optional string given_name = 3;
  optional string surname = 4;
}

message PayPalCapturedPurchaseUnit {
  optional string reference_id = 1;
  repeated PayPalCapture captures = 2;
}

message PayPalCapture {
  string id = 1;
  string status = 2;
  PayPalAmount amount = 3;
}

message PayPalAmount {
  string currency_code = 1;
  string value = 2;
}

// ==================== GOCARDLESS MESSAGES ====================

message SetupGoCardlessMandateRequest {
  string client_id = 1;
  string societe_id = 2;
  string scheme = 3;  // 'bacs', 'sepa_core', 'ach', etc.
  optional string description = 4;
  string success_redirect_url = 5;
  optional string session_token = 6;
}

message GoCardlessMandateResponse {
  string id = 1;
  string client_id = 2;
  string mandate_id = 3;
  string status = 4;
  string scheme = 5;
  optional string bank_name = 6;
  optional string account_holder_name = 7;
  optional string account_number_ending = 8;
  optional string redirect_url = 9;
}

message GetGoCardlessMandateRequest {
  string client_id = 1;
  string societe_id = 2;
}

message CreateGoCardlessPaymentRequest {
  string client_id = 1;
  string societe_id = 2;
  int64 amount = 3;  // En centimes
  string currency = 4;
  optional string description = 5;
  optional string charge_date = 6;  // YYYY-MM-DD
  map<string, string> metadata = 7;
}

message GoCardlessPaymentResponse {
  string id = 1;
  string payment_id = 2;
  int64 amount = 3;
  string currency = 4;
  string status = 5;
  optional string charge_date = 6;
}

message CreateGoCardlessSubscriptionRequest {
  string client_id = 1;
  string societe_id = 2;
  int64 amount = 3;
  string currency = 4;
  string interval_unit = 5;  // 'weekly', 'monthly', 'yearly'
  int32 interval = 6;
  optional string name = 7;
  optional string start_date = 8;
  optional int32 count = 9;  // Number of payments, omit for indefinite
  map<string, string> metadata = 10;
}

message GoCardlessSubscriptionResponse {
  string id = 1;
  string subscription_id = 2;
  int64 amount = 3;
  string currency = 4;
  string status = 5;
  string interval_unit = 6;
  int32 interval = 7;
  optional string next_payment_date = 8;
}

message CancelGoCardlessSubscriptionRequest {
  string subscription_id = 1;
  string societe_id = 2;
}

// ==================== SCHEDULE MESSAGES ====================

message CreateScheduleRequest {
  string organisation_id = 1;
  string societe_id = 2;
  optional string contrat_id = 3;
  optional string facture_id = 4;
  optional string client_id = 5;
  int64 amount = 6;
  string currency = 7;
  string due_date = 8;  // ISO date string
  optional string description = 9;
  bool auto_process = 10;
  map<string, string> metadata = 11;
}

message ScheduleResponse {
  string id = 1;
  string organisation_id = 2;
  string societe_id = 3;
  optional string contrat_id = 4;
  optional string facture_id = 5;
  optional string client_id = 6;
  int64 amount = 7;
  string currency = 8;
  string due_date = 9;
  string status = 10;  // PLANNED, PROCESSING, PENDING, PAID, FAILED, UNPAID, CANCELLED, EXPIRED
  optional string last_attempt_at = 11;
  optional string paid_at = 12;
  int32 retry_count = 13;
  optional string error_message = 14;
}

message UpdateScheduleRequest {
  string id = 1;
  optional int64 amount = 2;
  optional string due_date = 3;
  optional string status = 4;
  optional bool auto_process = 5;
}

message GetDueSchedulesRequest {
  string organisation_id = 1;
  optional string before_date = 2;  // Get schedules due before this date
}

message ScheduleListResponse {
  repeated ScheduleResponse schedules = 1;
  int32 total = 2;
}

message ProcessDuePaymentsRequest {
  string organisation_id = 1;
  optional bool dry_run = 2;  // If true, don't actually process
}

message ProcessDuePaymentsResponse {
  int32 processed_count = 1;
  int32 success_count = 2;
  int32 failed_count = 3;
  repeated ProcessedPayment results = 4;
}

message ProcessedPayment {
  string schedule_id = 1;
  bool success = 2;
  optional string payment_id = 3;
  optional string error = 4;
}

message RenewScheduleRequest {
  string id = 1;
  string new_due_date = 2;
  optional int64 new_amount = 3;
}

// ==================== PAYMENT INTENT MESSAGES ====================

message CreatePaymentIntentRequest {
  string organisation_id = 1;
  string societe_id = 2;
  optional string schedule_id = 3;
  string psp_name = 4;  // STRIPE, PAYPAL, GOCARDLESS, etc.
  int64 amount = 5;
  string currency = 6;
  optional string mandate_reference = 7;
  optional string idempotency_key = 8;
  map<string, string> metadata = 9;
}

message PaymentIntentResponse {
  string id = 1;
  string organisation_id = 2;
  string societe_id = 3;
  optional string schedule_id = 4;
  string psp_name = 5;
  optional string psp_payment_id = 6;
  int64 amount = 7;
  string currency = 8;
  string status = 9;  // PENDING, PROCESSING, SUCCEEDED, FAILED, CANCELLED
  optional string mandate_reference = 10;
  optional string idempotency_key = 11;
  optional string error_code = 12;
  optional string error_message = 13;
  string created_at = 14;
  optional string updated_at = 15;
}

message UpdatePaymentIntentRequest {
  string id = 1;
  optional string status = 2;
  optional string psp_payment_id = 3;
  optional string error_code = 4;
  optional string error_message = 5;
}

// ==================== PAYMENT EVENT MESSAGES ====================

message CreatePaymentEventRequest {
  string organisation_id = 1;
  string payment_intent_id = 2;
  string event_type = 3;  // PAYMENT_INITIATED, PAYMENT_CONFIRMED, PAYMENT_FAILED, etc.
  string raw_payload = 4;  // JSON string
}

message PaymentEventResponse {
  string id = 1;
  string organisation_id = 2;
  string payment_intent_id = 3;
  string event_type = 4;
  string raw_payload = 5;
  string received_at = 6;
  bool processed = 7;
  optional string processed_at = 8;
  optional string error_message = 9;
}

message GetUnprocessedEventsRequest {
  string organisation_id = 1;
  optional int32 limit = 2;
}

message PaymentEventListResponse {
  repeated PaymentEventResponse events = 1;
  int32 total = 2;
}

message MarkEventProcessedRequest {
  string id = 1;
  optional string error_message = 2;  // If processing failed
}

// ==================== PSP ACCOUNTS MESSAGES ====================

message GetPSPAccountsRequest {
  string societe_id = 1;
}

message PSPAccountsSummaryResponse {
  optional PSPAccountInfo stripe = 1;
  optional PSPAccountInfo paypal = 2;
  optional PSPAccountInfo gocardless = 3;
  optional PSPAccountInfo emerchantpay = 4;
  optional PSPAccountInfo slimpay = 5;
  optional PSPAccountInfo multisafepay = 6;
}

message PSPAccountInfo {
  string id = 1;
  string name = 2;
  bool is_active = 3;
  bool is_live_mode = 4;
  bool is_configured = 5;
}

// ==================== PORTAL PAYMENT SESSION ====================
// Secure link-based payment portal for customers

// Portal session status
enum PortalSessionStatus {
  PORTAL_SESSION_STATUS_UNSPECIFIED = 0;
  PORTAL_SESSION_CREATED = 1;      // Session created, token generated
  PORTAL_SESSION_ACTIVE = 2;       // First accessed
  PORTAL_SESSION_REDIRECTED = 3;   // Redirected to PSP
  PORTAL_SESSION_COMPLETED = 4;    // Payment completed
  PORTAL_SESSION_FAILED = 5;       // Payment failed
  PORTAL_SESSION_EXPIRED = 6;      // TTL exceeded
  PORTAL_SESSION_CANCELLED = 7;    // Manually cancelled
}

// Allowed actions on portal
enum PortalSessionAction {
  PORTAL_SESSION_ACTION_UNSPECIFIED = 0;
  PORTAL_ACTION_PAY_NOW = 1;       // Immediate payment
  PORTAL_ACTION_UPDATE_CARD = 2;   // Update payment method
  PORTAL_ACTION_SETUP_MANDATE = 3; // Setup direct debit mandate
}

// Portal error codes
enum PortalErrorCode {
  PORTAL_ERROR_CODE_UNSPECIFIED = 0;
  PORTAL_ERROR_SESSION_NOT_FOUND = 1;
  PORTAL_ERROR_SESSION_EXPIRED = 2;
  PORTAL_ERROR_SESSION_ALREADY_USED = 3;
  PORTAL_ERROR_SESSION_REVOKED = 4;
  PORTAL_ERROR_SESSION_TERMINAL = 5;
  PORTAL_ERROR_INVALID_TOKEN = 6;
  PORTAL_ERROR_TOKEN_MALFORMED = 7;
  PORTAL_ERROR_INVALID_TRANSITION = 8;
  PORTAL_ERROR_ACTION_NOT_ALLOWED = 9;
}

// PSP provider for portal
enum PortalPspProvider {
  PORTAL_PSP_PROVIDER_UNSPECIFIED = 0;
  PORTAL_PSP_STRIPE = 1;
  PORTAL_PSP_GOCARDLESS = 2;
  PORTAL_PSP_SLIMPAY = 3;
  PORTAL_PSP_EMERCHANTPAY = 4;
}

// Portal audit event types
enum PortalAuditEventType {
  PORTAL_AUDIT_EVENT_UNSPECIFIED = 0;
  PORTAL_SESSION_CREATED_EVENT = 1;
  PORTAL_SESSION_ACTIVATED_EVENT = 2;
  PORTAL_TOKEN_VALIDATED_EVENT = 3;
  PORTAL_TOKEN_REJECTED_EVENT = 4;
  PORTAL_SESSION_ACCESSED_EVENT = 5;
  PORTAL_REDIRECT_INITIATED_EVENT = 6;
  PORTAL_PAYMENT_INITIATED_EVENT = 7;
  PORTAL_PAYMENT_COMPLETED_EVENT = 8;
  PORTAL_PAYMENT_FAILED_EVENT = 9;
  PORTAL_SESSION_EXPIRED_EVENT = 10;
  PORTAL_SESSION_CANCELLED_EVENT = 11;
}

// Actor type for portal audit
enum PortalAuditActorType {
  PORTAL_AUDIT_ACTOR_UNSPECIFIED = 0;
  PORTAL_ACTOR_SYSTEM = 1;
  PORTAL_ACTOR_ADMIN = 2;
  PORTAL_ACTOR_PORTAL_TOKEN = 3;
  PORTAL_ACTOR_WEBHOOK = 4;
}

// Request to create a portal session
message CreatePortalSessionRequest {
  string organisation_id = 1;
  string societe_id = 2;
  string customer_id = 3;
  optional string contract_id = 4;
  optional string payment_intent_id = 5;
  repeated PortalSessionAction allowed_actions = 6;
  optional int32 ttl_seconds = 7;           // Time-to-live, default 900 (15 min)
  optional int32 max_uses = 8;              // Default 1
  int64 amount_cents = 9;
  optional string currency = 10;            // Default EUR
  optional string description = 11;
  optional string mandate_id = 12;
  optional string rum_masked = 13;          // Masked RUM for display
  optional string idempotency_key = 14;
  map<string, string> metadata = 15;
}

// Response after creating a portal session
message CreatePortalSessionResponse {
  PortalPaymentSession session = 1;
  string token = 2;                         // One-time use token (returned only on creation)
  string portal_url = 3;                    // Full URL to the payment portal
  bool was_idempotent_hit = 4;              // True if returned from idempotency cache
}

// Portal payment session entity
message PortalPaymentSession {
  string id = 1;
  string organisation_id = 2;
  string societe_id = 3;
  string customer_id = 4;
  optional string contract_id = 5;
  optional string payment_intent_id = 6;
  
  // Token (hash stored, never exposed)
  string token_version = 7;
  
  // State
  PortalSessionStatus status = 8;
  repeated PortalSessionAction allowed_actions = 9;
  
  // Timing
  string expires_at = 10;
  int32 max_uses = 11;
  int32 use_count = 12;
  optional string consumed_at = 13;
  optional string revoked_at = 14;
  optional string last_accessed_at = 15;
  
  // Payment details
  int64 amount_cents = 16;
  string currency = 17;
  optional string description = 18;
  optional string mandate_id = 19;
  optional string rum_masked = 20;
  
  // PSP state (for redirect flow)
  optional string psp_state = 21;
  optional string psp_redirect_url = 22;
  optional PortalPspProvider psp_provider = 23;
  optional string psp_session_id = 24;
  
  // Metadata
  map<string, string> metadata = 25;
  
  // Audit
  string created_at = 26;
  string updated_at = 27;
}

// Validate a portal token
message ValidatePortalTokenRequest {
  string token = 1;
  optional string ip_address_hash = 2;
  optional string user_agent_hash = 3;
  optional string request_id = 4;
}

message ValidatePortalTokenResponse {
  bool valid = 1;
  optional PortalPaymentSession session = 2;
  optional PortalErrorCode error_code = 3;
  optional string error_message = 4;
}

// Access a portal session (marks as active)
message AccessPortalSessionRequest {
  string token = 1;
  optional string ip_address_hash = 2;
  optional string user_agent_hash = 3;
  optional string request_id = 4;
}

message AccessPortalSessionResponse {
  PortalPaymentSession session = 1;
}

// Consume a portal token (for payment action)
message ConsumePortalTokenRequest {
  string token = 1;
  PortalSessionAction action = 2;
  optional string ip_address_hash = 3;
  optional string user_agent_hash = 4;
  optional string request_id = 5;
}

message ConsumePortalTokenResponse {
  PortalPaymentSession session = 1;
}

// Cancel a portal session
message CancelPortalSessionRequest {
  string session_id = 1;
  optional string reason = 2;
}

message CancelPortalSessionResponse {
  PortalPaymentSession session = 1;
}

// Update PSP info on portal session
message UpdatePortalPspInfoRequest {
  string session_id = 1;
  string psp_state = 2;
  string psp_redirect_url = 3;
  PortalPspProvider psp_provider = 4;
  string psp_session_id = 5;
}

message UpdatePortalPspInfoResponse {
  bool success = 1;
}

// Transition portal session status
message TransitionPortalSessionRequest {
  string session_id = 1;
  PortalSessionStatus new_status = 2;
  optional string reason = 3;
  optional string ip_address_hash = 4;
  optional string user_agent_hash = 5;
}

message TransitionPortalSessionResponse {
  PortalPaymentSession session = 1;
}

// Portal session audit log entry
message PortalSessionAuditLog {
  string id = 1;
  string portal_session_id = 2;
  PortalAuditEventType event_type = 3;
  PortalAuditActorType actor_type = 4;
  optional string previous_status = 5;
  optional string new_status = 6;
  optional string ip_address_hash = 7;
  optional string user_agent_hash = 8;
  optional string request_id = 9;
  optional string correlation_id = 10;
  map<string, string> data = 11;
  string timestamp = 12;
}

// List portal sessions
message ListPortalSessionsRequest {
  string organisation_id = 1;
  optional string societe_id = 2;
  optional string customer_id = 3;
  optional PortalSessionStatus status = 4;
  optional string from_date = 5;
  optional string to_date = 6;
  optional int32 page = 7;
  optional int32 limit = 8;
}

message ListPortalSessionsResponse {
  repeated PortalPaymentSession sessions = 1;
  int32 total = 2;
  int32 page = 3;
  int32 total_pages = 4;
}

// Get portal session audit logs
message GetPortalSessionAuditRequest {
  string session_id = 1;
}

message GetPortalSessionAuditResponse {
  repeated PortalSessionAuditLog logs = 1;
}

// Portal session stats
message GetPortalSessionStatsRequest {
  string organisation_id = 1;
  optional string societe_id = 2;
  string from_date = 3;
  string to_date = 4;
}

message GetPortalSessionStatsResponse {
  int32 total_created = 1;
  int32 total_completed = 2;
  int32 total_failed = 3;
  int32 total_expired = 4;
  int32 total_cancelled = 5;
  double completion_rate = 6;
}

// Request context for portal operations
message PortalRequestContext {
  optional string ip_hash = 1;
  optional string ua_hash = 2;
  optional string request_id = 3;
  optional string correlation_id = 4;
}

// ==================== INTERNAL CONFIG TYPES ====================
// These are internal types for PSP configuration

// GoCardless configuration
message GoCardlessConfig {
  string access_token = 1;
  string base_url = 2;
}

// Slimpay OAuth token (cached)
message SlimpayToken {
  string access_token = 1;
  int64 expires_at = 2;  // Unix timestamp
}

// ==================== SLIMPAY MESSAGES ====================

message CreateSlimpayMandateRequest {
  string societe_id = 1;
  string client_id = 2;
  string scheme = 3;  // 'sepa_core', 'sepa_b2b'
  string subscriber_reference = 4;
  string first_name = 5;
  string last_name = 6;
  string email = 7;
  optional string phone = 8;
  optional string iban = 9;
  optional string bic = 10;
  string success_url = 11;
  string failure_url = 12;
  map<string, string> metadata = 13;
}

message SlimpayMandateResponse {
  string id = 1;
  string mandate_id = 2;
  string client_id = 3;
  string status = 4;  // PENDING, ACTIVE, SUSPENDED, REVOKED, CANCELLED
  string scheme = 5;
  string rum = 6;  // Référence Unique de Mandat
  optional string subscriber_reference = 7;
  optional string bank_name = 8;
  optional string iban_last4 = 9;
  optional string bic = 10;
  optional string signature_date = 11;
  optional string redirect_url = 12;  // For mandate signature flow
  string created_at = 13;
  optional string updated_at = 14;
}

message GetSlimpayMandateRequest {
  string mandate_id = 1;
  string societe_id = 2;
}

message CancelSlimpayMandateRequest {
  string mandate_id = 1;
  string societe_id = 2;
  optional string reason = 3;
}

message CreateSlimpayPaymentRequest {
  string societe_id = 1;
  string mandate_id = 2;
  int64 amount_cents = 3;
  string currency = 4;
  string label = 5;  // Payment label / description
  optional string execution_date = 6;  // ISO date, defaults to next business day
  optional string idempotency_key = 7;
  map<string, string> metadata = 8;
}

message SlimpayPaymentResponse {
  string id = 1;
  string payment_id = 2;
  string mandate_id = 3;
  int64 amount_cents = 4;
  string currency = 5;
  string status = 6;  // PENDING, PROCESSING, EXECUTED, REJECTED, REFUNDED
  optional string label = 7;
  optional string execution_date = 8;
  optional string rejection_reason = 9;
  optional string rejection_code = 10;  // e.g. AM04
  string created_at = 11;
  optional string updated_at = 12;
}

message GetSlimpayPaymentRequest {
  string payment_id = 1;
  string societe_id = 2;
}

// ==================== MULTISAFEPAY MESSAGES ====================

message CreateMultiSafepayTransactionRequest {
  string societe_id = 1;
  string order_id = 2;
  int64 amount_cents = 3;
  string currency = 4;
  string payment_type = 5;  // 'redirect', 'direct'
  string gateway = 6;  // 'IDEAL', 'VISA', 'MASTERCARD', 'BANCONTACT', etc.
  optional string description = 7;
  string notification_url = 8;
  string redirect_url = 9;
  string cancel_url = 10;
  optional string customer_email = 11;
  optional string customer_first_name = 12;
  optional string customer_last_name = 13;
  map<string, string> metadata = 14;
}

message MultiSafepayTransactionResponse {
  string id = 1;
  string transaction_id = 2;
  string order_id = 3;
  int64 amount_cents = 4;
  string currency = 5;
  string status = 6;  // INITIALIZED, COMPLETED, DECLINED, VOID, REFUNDED, CHARGEBACK
  string gateway = 7;
  optional string payment_url = 8;  // Redirect URL for customer
  optional string reason = 9;
  string created_at = 10;
  optional string updated_at = 11;
}

message GetMultiSafepayTransactionRequest {
  string transaction_id = 1;
  string societe_id = 2;
}

message RefundMultiSafepayTransactionRequest {
  string transaction_id = 1;
  string societe_id = 2;
  int64 amount_cents = 3;  // Partial or full refund
  optional string description = 4;
}

// ==================== EMERCHANTPAY MESSAGES ====================

message CreateEmerchantpayPaymentRequest {
  string societe_id = 1;
  string transaction_id = 2;  // Unique merchant transaction ID
  int64 amount_cents = 3;
  string currency = 4;
  string transaction_type = 5;  // 'sale', 'authorize', 'init_recurring_sale'
  optional string card_number = 6;
  optional string card_holder = 7;
  optional string expiration_date = 8;
  optional string cvv = 9;
  string notification_url = 10;
  string return_success_url = 11;
  string return_failure_url = 12;
  optional string customer_email = 13;
  optional string customer_phone = 14;
  optional string billing_address = 15;  // JSON string
  map<string, string> metadata = 16;
}

message EmerchantpayPaymentResponse {
  string id = 1;
  string transaction_id = 2;
  string unique_id = 3;  // Emerchantpay unique ID
  int64 amount_cents = 4;
  string currency = 5;
  string status = 6;  // PENDING, APPROVED, DECLINED, ERROR, REFUNDED, VOIDED, CHARGEBACKED
  string transaction_type = 7;
  optional string redirect_url = 8;  // For 3DS or WPF
  optional string reason = 9;
  optional string response_code = 10;
  string created_at = 11;
  optional string updated_at = 12;
}

message GetEmerchantpayPaymentRequest {
  string transaction_id = 1;
  string societe_id = 2;
}

message CreateEmerchantpaySepaPaymentRequest {
  string societe_id = 1;
  string transaction_id = 2;
  int64 amount_cents = 3;
  string currency = 4;
  string iban = 5;
  string bic = 6;
  string account_holder = 7;
  optional string mandate_reference = 8;
  optional string mandate_signed_date = 9;  // ISO date
  string notification_url = 10;
  optional string description = 11;
  map<string, string> metadata = 12;
}

message RefundEmerchantpayPaymentRequest {
  string transaction_id = 1;
  string societe_id = 2;
  string unique_id = 3;  // Original payment unique_id
  int64 amount_cents = 4;  // Partial or full refund
  optional string reason = 5;
}

// ==================== PROVIDER ROUTING MESSAGES ====================

message CreateRoutingRuleRequest {
  string societe_id = 1;
  string name = 2;
  int32 priority = 3;  // 1 = highest
  string conditions = 4;  // JSON: {"source_channel": ["TERRAIN"], "contract_age_months_gte": 4, ...}
  string provider_account_id = 5;
  bool is_fallback = 6;
  bool is_enabled = 7;
}

message RoutingRuleResponse {
  string id = 1;
  string societe_id = 2;
  string name = 3;
  int32 priority = 4;
  string conditions = 5;  // JSON
  string provider_account_id = 6;
  bool is_fallback = 7;
  bool is_enabled = 8;
  string created_at = 9;
  string updated_at = 10;
}

message UpdateRoutingRuleRequest {
  string id = 1;
  optional string name = 2;
  optional int32 priority = 3;
  optional string conditions = 4;  // JSON
  optional string provider_account_id = 5;
  optional bool is_fallback = 6;
  optional bool is_enabled = 7;
}

message DeleteRoutingRuleRequest {
  string id = 1;
  string societe_id = 2;
}

message DeleteRoutingRuleResponse {
  bool success = 1;
  string message = 2;
}

message ListRoutingRulesRequest {
  string societe_id = 1;
  optional bool is_enabled = 2;
  optional int32 page = 3;
  optional int32 page_size = 4;
}

message ListRoutingRulesResponse {
  repeated RoutingRuleResponse rules = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message TestRoutingRuleRequest {
  string societe_id = 1;
  string source_channel = 2;  // TERRAIN, WEB, etc.
  optional string product_code = 3;
  optional int32 contract_age_months = 4;
  optional int64 amount_cents = 5;
  optional string client_id = 6;
}

message TestRoutingRuleResponse {
  string matched_rule_id = 1;
  string matched_rule_name = 2;
  string provider_account_id = 3;
  string provider_name = 4;
  bool is_fallback = 5;
  repeated RoutingRuleEvaluation evaluations = 6;
}

message RoutingRuleEvaluation {
  string rule_id = 1;
  string rule_name = 2;
  int32 priority = 3;
  bool matched = 4;
  optional string reason = 5;
}

message CreateProviderOverrideRequest {
  string societe_id = 1;
  string scope = 2;  // 'CLIENT' or 'CONTRAT'
  string scope_id = 3;  // Client ID or Contract ID
  string provider_account_id = 4;
  string reason = 5;
}

message ProviderOverrideResponse {
  string id = 1;
  string societe_id = 2;
  string scope = 3;
  string scope_id = 4;
  string provider_account_id = 5;
  string reason = 6;
  string created_by = 7;
  string created_at = 8;
}

message DeleteProviderOverrideRequest {
  string id = 1;
  string societe_id = 2;
}

message DeleteProviderOverrideResponse {
  bool success = 1;
  string message = 2;
}

message ListProviderOverridesRequest {
  string societe_id = 1;
  optional string scope = 2;
  optional string scope_id = 3;
  optional int32 page = 4;
  optional int32 page_size = 5;
}

message ListProviderOverridesResponse {
  repeated ProviderOverrideResponse overrides = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message CreateReassignmentJobRequest {
  string societe_id = 1;
  string from_provider_account_id = 2;
  string to_provider_account_id = 3;
  string selection_query = 4;  // JSON: criteria for selecting affected items
  bool dry_run = 5;
  optional string scheduled_at = 6;  // ISO datetime, if not provided runs immediately
}

message ReassignmentJobResponse {
  string id = 1;
  string societe_id = 2;
  string from_provider_account_id = 3;
  string to_provider_account_id = 4;
  string selection_query = 5;  // JSON
  string status = 6;  // DRAFT, SCHEDULED, RUNNING, COMPLETED, FAILED, ROLLED_BACK
  bool dry_run = 7;
  optional string scheduled_at = 8;
  optional string started_at = 9;
  optional string completed_at = 10;
  int32 total_items = 11;
  int32 success_count = 12;
  int32 failed_count = 13;
  optional string report_file_id = 14;
  string created_at = 15;
  string updated_at = 16;
}

message GetReassignmentJobRequest {
  string id = 1;
  string societe_id = 2;
}

// ==================== ALERT MESSAGES ====================

message ListAlertsRequest {
  string societe_id = 1;
  optional string alert_type = 2;  // PROVIDER_ROUTING_NOT_FOUND, HIGH_REJECTION_RATE, etc.
  optional string severity = 3;  // INFO, WARNING, CRITICAL
  optional bool acknowledged = 4;
  optional string from_date = 5;
  optional string to_date = 6;
  optional int32 page = 7;
  optional int32 page_size = 8;
}

message ListAlertsResponse {
  repeated AlertResponse alerts = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message AlertResponse {
  string id = 1;
  string societe_id = 2;
  string alert_type = 3;
  string severity = 4;
  string title = 5;
  string message = 6;
  string context = 7;  // JSON with additional details
  bool acknowledged = 8;
  optional string acknowledged_by = 9;
  optional string acknowledged_at = 10;
  string created_at = 11;
}

message AcknowledgeAlertRequest {
  string id = 1;
  string societe_id = 2;
  string acknowledged_by = 3;
}

message GetAlertStatsRequest {
  string societe_id = 1;
  string from_date = 2;
  string to_date = 3;
}

message AlertStatsResponse {
  int32 total_alerts = 1;
  int32 unacknowledged = 2;
  int32 critical_count = 3;
  int32 warning_count = 4;
  int32 info_count = 5;
  repeated AlertTypeCount by_type = 6;
}

message AlertTypeCount {
  string alert_type = 1;
  int32 count = 2;
}

// ==================== ACCOUNTING EXPORT MESSAGES ====================

message CreateExportJobRequest {
  string societe_id = 1;
  string export_type = 2;  // SEPA_XML, CSV_ACCOUNTING, FEC, CUSTOM
  string from_date = 3;
  string to_date = 4;
  optional string format = 5;  // CSV, XML, JSON
  optional string filters = 6;  // JSON: additional filters
  map<string, string> metadata = 7;
}

message ExportJobResponse {
  string id = 1;
  string societe_id = 2;
  string export_type = 3;
  string status = 4;  // PENDING, PROCESSING, COMPLETED, FAILED
  string from_date = 5;
  string to_date = 6;
  optional string format = 7;
  optional string file_url = 8;  // Download URL when completed
  optional string file_name = 9;
  optional int64 file_size_bytes = 10;
  int32 record_count = 11;
  optional string error_message = 12;
  string created_at = 13;
  optional string completed_at = 14;
}

message GetExportJobRequest {
  string id = 1;
  string societe_id = 2;
}

message ListExportJobsRequest {
  string societe_id = 1;
  optional string export_type = 2;
  optional string status = 3;
  optional int32 page = 4;
  optional int32 page_size = 5;
}

message ListExportJobsResponse {
  repeated ExportJobResponse jobs = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message DownloadExportRequest {
  string id = 1;
  string societe_id = 2;
}

message DownloadExportResponse {
  bytes file_content = 1;
  string file_name = 2;
  string content_type = 3;
  int64 file_size_bytes = 4;
}

// ==================== RISK SCORING MESSAGES ====================

message GetRiskScoreRequest {
  string id = 1;
  string societe_id = 2;
}

message RiskScoreResponse {
  string id = 1;
  string societe_id = 2;
  string entity_type = 3;  // CLIENT, CONTRACT, PAYMENT
  string entity_id = 4;
  int32 score = 5;  // 0-100
  string risk_level = 6;  // LOW, MEDIUM, HIGH, CRITICAL
  repeated RiskFactor factors = 7;
  string evaluated_at = 8;
  optional string expires_at = 9;
}

message RiskFactor {
  string name = 1;
  int32 weight = 2;
  int32 score = 3;
  string description = 4;
}

message EvaluateRiskScoreRequest {
  string societe_id = 1;
  string entity_type = 2;  // CLIENT, CONTRACT, PAYMENT
  string entity_id = 3;
  bool force_refresh = 4;
}

message ListRiskScoresRequest {
  string societe_id = 1;
  optional string entity_type = 2;
  optional string risk_level = 3;
  optional int32 min_score = 4;
  optional int32 max_score = 5;
  optional int32 page = 6;
  optional int32 page_size = 7;
}

message ListRiskScoresResponse {
  repeated RiskScoreResponse scores = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message GetScoringStatsRequest {
  string societe_id = 1;
  string from_date = 2;
  string to_date = 3;
}

message ScoringStatsResponse {
  int32 total_evaluated = 1;
  int32 low_risk_count = 2;
  int32 medium_risk_count = 3;
  int32 high_risk_count = 4;
  int32 critical_risk_count = 5;
  double average_score = 6;
}

// ==================== BANK RECONCILIATION MESSAGES ====================

message ImportBankStatementRequest {
  string societe_id = 1;
  string bank_account_id = 2;
  string format = 3;  // CAMT053, MT940, CSV
  bytes file_content = 4;
  string file_name = 5;
  optional string statement_date = 6;  // ISO date
}

message ImportBankStatementResponse {
  string id = 1;
  string societe_id = 2;
  string status = 3;  // IMPORTED, PROCESSING, RECONCILED, PARTIAL, FAILED
  int32 total_transactions = 4;
  int32 matched_count = 5;
  int32 unmatched_count = 6;
  int64 total_credit_cents = 7;
  int64 total_debit_cents = 8;
  string imported_at = 9;
}

message GetReconciliationStatusRequest {
  string societe_id = 1;
  optional string bank_account_id = 2;
  optional string from_date = 3;
  optional string to_date = 4;
}

message ReconciliationStatusResponse {
  string societe_id = 1;
  int32 total_statements = 2;
  int32 fully_reconciled = 3;
  int32 partially_reconciled = 4;
  int32 pending = 5;
  int64 total_unmatched_amount_cents = 6;
  double reconciliation_rate = 7;  // Percentage
  optional string last_import_at = 8;
}

message ForceReconciliationRequest {
  string societe_id = 1;
  string bank_transaction_id = 2;
  string payment_id = 3;
  optional string reason = 4;
}

message ReconciliationResponse {
  string id = 1;
  string bank_transaction_id = 2;
  string payment_id = 3;
  string status = 4;  // MATCHED, FORCED, DISPUTED
  int64 bank_amount_cents = 5;
  int64 payment_amount_cents = 6;
  optional string reason = 7;
  string reconciled_at = 8;
  optional string reconciled_by = 9;
}

message ListUnmatchedPaymentsRequest {
  string societe_id = 1;
  optional string source = 2;  // BANK or SYSTEM (unmatched from which side)
  optional string from_date = 3;
  optional string to_date = 4;
  optional int32 page = 5;
  optional int32 page_size = 6;
}

message ListUnmatchedPaymentsResponse {
  repeated UnmatchedPayment payments = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message UnmatchedPayment {
  string id = 1;
  string source = 2;  // BANK or SYSTEM
  int64 amount_cents = 3;
  string currency = 4;
  optional string reference = 5;
  optional string description = 6;
  string date = 7;
  optional string suggested_match_id = 8;  // System-suggested match
  optional int32 match_confidence = 9;  // 0-100
}

// ==================== PROVIDER STATUS MAPPING MESSAGES ====================

message ListProviderStatusMappingsRequest {
  string societe_id = 1;
  optional string provider_name = 2;  // SLIMPAY, MULTISAFEPAY, EMERCHANTPAY, GOCARDLESS
}

message ListProviderStatusMappingsResponse {
  repeated ProviderStatusMappingResponse mappings = 1;
  int32 total = 2;
}

message ProviderStatusMappingResponse {
  string id = 1;
  string provider_name = 2;
  string provider_status = 3;  // Raw status from PSP
  string internal_status = 4;  // Mapped internal PaymentStatus
  string event_type = 5;  // e.g. payment.executed, payment.rejected
  optional string rejection_category = 6;  // REJECT_INSUFF_FUNDS, REJECT_OTHER, etc.
  optional string retry_advice = 7;  // AUTO, MANUAL, NONE
  bool is_active = 8;
  string updated_at = 9;
}

message UpdateProviderStatusMappingRequest {
  string id = 1;
  optional string internal_status = 2;
  optional string rejection_category = 3;
  optional string retry_advice = 4;
  optional bool is_active = 5;
}

// ==================== REJECTION REASON MESSAGES ====================

message ListRejectionReasonsRequest {
  string societe_id = 1;
  optional string provider_name = 2;
  optional string category = 3;  // INSUFF_FUNDS, ACCOUNT_CLOSED, UNAUTHORIZED, TECHNICAL, OTHER
  optional bool is_active = 4;
  optional int32 page = 5;
  optional int32 page_size = 6;
}

message ListRejectionReasonsResponse {
  repeated RejectionReasonResponse reasons = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message RejectionReasonResponse {
  string id = 1;
  string code = 2;  // e.g. AM04, AC01, MD01
  string label = 3;
  string description = 4;
  string category = 5;  // INSUFF_FUNDS, ACCOUNT_CLOSED, UNAUTHORIZED, TECHNICAL, OTHER
  string retry_strategy = 6;  // AUTO_RETRY, MANUAL_REVIEW, NO_RETRY
  optional int32 max_retries = 7;
  optional int32 retry_delay_days = 8;
  bool is_active = 9;
  string created_at = 10;
  string updated_at = 11;
}

message CreateRejectionReasonRequest {
  string societe_id = 1;
  string code = 2;
  string label = 3;
  string description = 4;
  string category = 5;
  string retry_strategy = 6;
  optional int32 max_retries = 7;
  optional int32 retry_delay_days = 8;
}

message UpdateRejectionReasonRequest {
  string id = 1;
  optional string label = 2;
  optional string description = 3;
  optional string category = 4;
  optional string retry_strategy = 5;
  optional int32 max_retries = 6;
  optional int32 retry_delay_days = 7;
  optional bool is_active = 8;
}
